var CinemaFilterControl=Class.create();Object.extend(CinemaFilterControl.prototype,{server:{},options:{clickRegion:"",container:"",districtJson:null,subwayJson:null,callBack:null},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeServerData();this.initializeDOM();this.initializeEvent();this.initializeControl();this.load()},initializeServerData:function(){},initializeDOM:function(){this.clickRegionDom=$(this.clickRegion);this.containerRegion=$(this.container)},destroyDOM:function(){this.clickRegionDom=null;this.containerRegion=null},initializeEvent:function(){this.clickRegionHandler=this.onClickRegion.bind(this);this.clickRegionDom&&Event.observe(this.clickRegionDom,"click",this.clickRegionHandler);this.clickContainerRegionHandler=this.onClickContainerRegion.bind(this);this.containerRegion&&Event.observe(this.containerRegion,"click",this.clickContainerRegionHandler);this.onClickWindowHandler=this.onClickWindow.bind(this);Event.observe(document.body,"click",this.onClickWindowHandler);Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){this.clickRegionDom&&Event.stopObserving(this.clickRegionDom,"click",this.clickRegionHandler);Event.stopObserving(document.body,"click",this.onClickWindowHandler)},initializeControl:function(){},destroyControl:function(){},load:function(){},onClickWindow:function(f){var d=Event.element(f);var e=d.up("div.showcitybox");if((d==document||d.readAttribute("id")!=this.clickRegion)&&(!e||e.readAttribute("id")!=this.container)){if(this.containerRegion){this.clickRegionDom.removeClassName("curr");this.containerRegion.hide()}}},onClickRegion:function(g){var e=Event.findElement(g,"a");if(e&&e!=document){this.clickRegionDom.setAttribute("rt","");this.clickRegionDom.setAttribute("rid",0);this.clickRegionDom.removeClassName("curr");this.clickRegionDom.innerHTML='商圈及地铁沿线 <i class="ico_f_jiao">&nbsp;</i><em>&nbsp;</em>';this.containerRegion.hide();this.callBack&&this.callBack("",0);return}if(this.containerRegion.visible()){this.clickRegionDom.removeClassName("curr");this.containerRegion.hide();return}if((typeof this.districtJson!="undefined"&&this.districtJson.length>0)||(typeof this.subwayJson!="undefined"&&this.subwayJson.length>0)){if(this.containerRegion){var f="ds";var h=new StringBuilder();h.append('<div class="aside fl"><ul>');if(typeof this.districtJson!="undefined"&&this.districtJson.length>0&&typeof this.subwayJson!="undefined"&&this.subwayJson.length>0){h.append('<li rt="dslabel" class="curr">地区商圈<i class="ico_cityjiao"></i></li>');h.append('<li rt="sblabel">地铁沿线<i class="ico_cityjiao" style="display:none;"></i></li>')}else{if(typeof this.districtJson!="undefined"&&this.districtJson.length>0){h.append('<li rt="dslabel" class="curr">地区商圈<i class="ico_cityjiao"></i></li>')}else{f="sb";h.append('<li rt="sblabel" class="curr">地铁沿线<i class="ico_cityjiao"></i></li>')}}h.append("</ul></div>");h.append('<div class="main fl">');h.append('<ul id="relatedObjs">');h.append("</ul></div>");this.containerRegion.innerHTML=h.toString();this.render(f);this.clickRegionDom.addClassName("curr");this.containerRegion.show()}}},render:function(d){if($("relatedObjs")){var c=new StringBuilder();if(d=="ds"){c.append(this.districtItemRender())}else{if(d=="sb"){c.append(this.subwayItemRender())}else{}}$("relatedObjs").innerHTML=c.toString()}},districtItemRender:function(){var k=new StringBuilder();if(typeof this.districtJson!="undefined"&&this.districtJson.length>0){var j=false;for(var l=0;l<this.districtJson.length;l++){var h=this.districtJson[l];k.append(String.format('<li><b class="fl"><a rt="ds" rid="{1}" href="#" onclick="return false;">{0}：</a></b>',h.name,h.id));if(typeof h.bs!="undefined"&&h.bs.length>0){j=true;k.append('<p class=" fl">');for(var m=0;m<h.bs.length;m++){var g=h.bs[m];k.append(String.format('<a rt="bs" rid="{0}" href="#" onclick="return false;">{1}</a>',g.bid,g.bname))}k.append("</p>")}k.append("</li>")}if(!j){if(!$("relatedObjs").hasClassName("onlylist")){$("relatedObjs").addClassName("onlylist")}}else{$("relatedObjs").removeClassName("onlylist")}}return k.toString()},subwayItemRender:function(){var h=new StringBuilder();if(typeof this.subwayJson!="undefined"&&this.subwayJson.length>0){var g=false;for(var j=0;j<this.subwayJson.length;j++){var l=this.subwayJson[j];h.append(String.format('<li><b class="fl"><a rt="sb" rid="{1}" href="#" onclick="return false;">{0}：</a></b><p class=" fl">',l.name,l.id));if(typeof l.sts!="undefined"&&l.sts.length>0){g=true;for(var k=0;k<l.sts.length;k++){var m=l.sts[k];h.append(String.format('<a rt="st" rid="{0}" href="#" onclick="return false;">{1}</a>',m.sid,m.sname))}}h.append("</p></li>")}if(!g){if(!$("relatedObjs").hasClassName("onlylist")){$("relatedObjs").addClassName("onlylist")}}else{$("relatedObjs").removeClassName("onlylist")}}return h.toString()},onClickContainerRegion:function(g){var f=Event.element(g);var h=f.readAttribute("rt");while(!h&&f!=document.body){f=f.up();h=f.readAttribute("rt")}if(!h){return}var j=f.readAttribute("rid");var k=f.innerHTML.replace("：","");if(h=="dslabel"){this.render("ds");f.up().down("li.curr").down("i").hide();f.up().down("li.curr").removeClassName("curr");f.addClassName("curr");f.down("i").show()}else{if(h=="sblabel"){this.render("sb");f.up().down("li.curr").down("i").hide();f.up().down("li.curr").removeClassName("curr");f.addClassName("curr");f.down("i").show()}else{if(h!=""&&j&&j!=""){this.clickRegionDom.setAttribute("rt",h);this.clickRegionDom.setAttribute("rid",j);this.clickRegionDom.removeClassName("curr");this.clickRegionDom.innerHTML=k+' <a href="#" class="txt_close" onclick="return false;">×</a><i class="ico_f_jiao">&nbsp;</i><em>&nbsp;</em>';this.containerRegion.hide();this.callBack&&this.callBack(h,j)}}}},close:function(){this.destroyControl();this.destroyEvent();this.destroyDOM()}});var CinemaListControl=Class.create();Object.extend(CinemaListControl.prototype,{options:{pageSize:10},server:{GetCinemaFavorite:function(b){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetCinemaFavorites",[],b,"/Cinema.api","get","60000",null)},AddFavorite:function(e,d,f){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","AddCinemaFavorite",[e],d,"/Cinema.api","get","60000",f)},DelFavorite:function(e,d,f){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","DelCinemaFavorite",[e],d,"/Cinema.api","get","60000",f)}},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeServerData();this.initializeDOM();this.initializeEvent();this.initializeControl();this.load()},initializeServerData:function(){this.isLogin=false;this.locationFilterType="";this.locationFilterId=0;this.featureFilterValue=[];this.pageIndex=1},initializeDOM:function(){this.featureFilterRegion=$("featureFilter");this.cinemaListRegion=$("cinemaListRegion");this.moreCinemaBtn=$("morecinema")},destroyDOM:function(){this.featureFilterRegion=null;this.cinemaListRegion=null;this.moreCinemaBtn=null},initializeEvent:function(){this.onClickCinemaRegionHandler=this.onClickCinemaRegion.bind(this);this.cinemaListRegion&&Event.observe(this.cinemaListRegion,"click",this.onClickCinemaRegionHandler);this.onClickMoreCinemaBtnHandler=this.onClickMoreCinemaBtn.bind(this);this.moreCinemaBtn&&Event.observe(this.moreCinemaBtn,"click",this.onClickMoreCinemaBtnHandler);if(Mtime.browser.ie!=0&&Mtime.browser.ie<=8){this.CinemaRegionMouseOverHandler=this.cinemaRegionMouseOver.bind(this);this.CinemaRegionMouseOutHandler=this.cinemaRegionMouseOut.bind(this);this.cinemaListRegion&&Event.observe(this.cinemaListRegion,"mouseover",this.CinemaRegionMouseOverHandler);this.cinemaListRegion&&Event.observe(this.cinemaListRegion,"mouseout",this.CinemaRegionMouseOutHandler)}Event.observe(window,"unload",this.close.bind(this));if(this.featureFilterRegion){this.onClickFilterRegionHandler=this.onClickFilterRegion.bind(this);Event.observe(this.featureFilterRegion,"click",this.onClickFilterRegionHandler)}},destroyEvent:function(){this.cinemaListRegion&&Event.stopObserving(this.cinemaListRegion,"click",this.onClickCinemaRegionHandler);this.moreCinemaBtn&&Event.stopObserving(this.moreCinemaBtn,"click",this.onClickMoreCinemaBtnHandler);if(Mtime.browser.ie!=0&&Mtime.browser.ie<=8){Event.stopObserving(this.cinemaListRegion,"mouseover",this.CinemaRegionMouseOverHandler);Event.stopObserving(this.cinemaListRegion,"mouseout",this.CinemaRegionMouseOutHandler)}},initializeControl:function(){},destroyControl:function(){},load:function(){if(this.cinemaListRegion){var d=false;if(typeof mtimeStufs!="undefined"){d=mtimeStufs.any(function(a){return(a.id=="M14_B_TheaterChannelIndex_RightTG1"&&a.content!="")||(a.id=="M14_B_TheaterChannelIndex_RightTG2"&&a.content!="")})}if(this.cinemaListRegion.up('div[data-selector="cinemas"]')){var c=this.cinemaListRegion.up('div[data-selector="cinemas"]').down('div[data-selector="activity"]');if((!c||c.innerHTML=="")&&!d){this.cinemaListRegion.up('div[data-selector="cinemas"]').addClassName("onlyfilmtick")}}}this.intilizFeatureFilterRender();this.observControl();this.intilizeCinemas()},intilizeCinemas:function(){this.server.GetCinemaFavorite(function(d){if(d&&d.value){if(d.value.success){this.isLogin=true;var c=d.value.favorites;if(typeof c!="undefined"&&c.length>0){this.CinemaSort(c);if(typeof cinemasJson!="undefined"&&cinemasJson.totalcount>0){this.validCinemas=cinemasJson.list.clone()}else{this.validCinemas=[]}this.CinemaListRender()}else{if(typeof cinemasJson!="undefined"&&cinemasJson.totalcount>0){this.validCinemas=cinemasJson.list.clone()}else{this.validCinemas=[]}this.CinemaListRender()}}else{if(typeof cinemasJson!="undefined"&&cinemasJson.totalcount>0){this.validCinemas=cinemasJson.list.clone()}else{this.validCinemas=[]}this.CinemaListRender()}}else{if(typeof cinemasJson!="undefined"&&cinemasJson.totalcount>0){this.validCinemas=cinemasJson.list.clone()}else{this.validCinemas=[]}this.CinemaListRender()}}.bind(this))},CinemaSort:function(h){if(typeof cinemasJson!="undefined"&&cinemasJson.totalcount>0&&typeof h!="undefined"&&h.length>0){var k=new Date();for(var j=0;j<cinemasJson.list.length;j++){var f=cinemasJson.list[j];var g=h.find(function(a){return a.cid==f.cid});if(g){cinemasJson.list[j].favtime=g.entertime}else{cinemasJson.list[j].favtime=0}}cinemasJson.list.sort(function(a,b){if(a.favtime==b.favtime){if(a.sortid==b.sortid){return 0}else{if(a.sortid>b.sortid){return 1}else{return -1}}}else{return b.favtime-a.favtime}})}},CinemaListRender:function(){if(this.cinemaListRegion){if(this.validCinemas.length>0){var j=new StringBuilder();var m=this.validCinemas.length;var l=(this.pageIndex-1)*this.pageSize;var h=Math.min(this.pageIndex*this.pageSize,m);for(var k=l;k<h;k++){var g=this.validCinemas[k];j.append(this.cinemaItemRender(g))}if(this.pageIndex==1){this.cinemaListRegion.innerHTML=j.toString()}else{this.cinemaListRegion.innerHTML+=j.toString()}if(this.pageIndex*this.pageSize>=m){this.cinemaListRegion.up("div").next("div").hide()}else{this.cinemaListRegion.up("div").next("div").show()}}else{this.cinemaListRegion.innerHTML="找不到影院"}}},getFilterCinemas:function(){if(typeof cinemasJson!=="undefined"&&typeof cinemasJson.totalcount!="undefined"&&cinemasJson.totalcount>0){if(this.locationFilterType==""&&this.featureFilterValue.length<=0){return cinemasJson.list}else{var j=[];for(var k=0;k<cinemasJson.totalcount;k++){var g=cinemasJson.list[k];var m=false;var h=true;if(this.locationFilterType!=""&&this.locationFilterId!=0){if(this.locationFilterType=="ds"){if(this.locationFilterId==g.did){m=true}}else{if(this.locationFilterType=="bs"){if(this.ExistRelationOjbId(g.bid,this.locationFilterId)){m=true}}else{if(this.locationFilterType=="sb"){if(this.ExistRelationOjbId(g.sbid,this.locationFilterId)){m=true}}else{if(this.locationFilterType=="st"){if(this.ExistRelationOjbId(g.sid,this.locationFilterId)){m=true}}else{}}}}}else{m=true}if(this.featureFilterValue.length>0){for(var l=0;l<this.featureFilterValue.length;l++){if(g.filtervalue.indexOf(this.featureFilterValue[l])<0){h=false}}}if(m&&h){j.push(g)}}return j}}return null},ExistRelationOjbId:function(f,d){if(f==""||f=="0"||d==0){return false}var e=f.split(",");return e.include(d)},cinemaItemRender:function(g){if(typeof g!="undefined"){var j=new StringBuilder();j.append("<li>");j.append(String.format('<a href="{0}" target="_blank" title="{1}" class="picbox loadtempimg">',g.showtimepage,g.cname));var k="";if(g.logo==""){k="cinema10263"}j.append(String.format('<img class="{2}" width="102" height="63" src="{0}" alt="{1}">',g.logo,g.cname,k));j.append("</a>");j.append('<dl class="movieinfobox">');j.append(String.format('<dt data-selector="favregion"><a href="{0}" target="_blank" class="htitle">{1}</a>',g.showtimepage,g.cname));var f=g.favtime>0?"currstar":"";var h=g.favtime>0?"":'style="display:none;"';j.append(String.format('<a method="addfavorite" cid="{0}" href="#" class="ico_stat {1}" onclick="return false;">我常去</a>',g.cid,f));j.append(String.format('<a method="delfavorite" cid="{0}" href="#" class="ico_stat ico_end" onclick="return false;" {1}>取消</a>',g.cid,h));j.append("</dt>");j.append('<dd class="infotxt filmicon">');j.append(String.format("<p>{0}</p>",this.getChineseSubString(g.address,25)));j.append('<div class="moretool">');j.append(this.CinemaFeatureRender(g));j.append("</div>");j.append(this.CinemaPromotionTagRender(g));if(g.lowestprice&&g.lowestprice!=""){j.append('<div class="ticketselect">');j.append(String.format("<p><span>¥</span>{0}<span>元起</span></p>",g.lowestprice));j.append(String.format('<a href="{0}" class="ico_c_ticket">选座购票</a></div>',g.showtimepage))}j.append("</dd>");j.append("</dl>");j.append("</li>");return j.toString()}return""},CinemaFeatureRender:function(cinema){var featureAndServices=[];if(cinema){if(cinema.feature&&cinema.feature!=""){var featureJson=eval("("+cinema.feature+")");if(featureJson.FeatureIMAX==1){featureAndServices.push(String.format('<i class="ico_c_f01" title="{0}">&nbsp;</i>',featureJson.FeatureIMAXContent))}if(featureJson.Feature3D==1){featureAndServices.push(String.format('<i class="ico_c_f02" title="{0}">&nbsp;</i>',featureJson.Feature3DContent))}if(featureJson.FeatureVIP==1){featureAndServices.push(String.format('<i class="ico_c_f03" title="{0}">&nbsp;</i>',featureJson.FeatureVIPContent))}if(featureJson.FeatureHuge==1){featureAndServices.push(String.format('<i class="ico_c_f04" title="{0}">&nbsp;</i>',featureJson.FeatureHugeContent))}if(featureJson.Feature4K==1){featureAndServices.push(String.format('<i class="ico_c_f08" title="{0}">&nbsp;</i>',featureJson.Feature4KContent))}if(featureJson.FeatureDolby==1){featureAndServices.push(String.format('<i class="ico_c_f06" title="{0}">&nbsp;</i>',featureJson.FeatureDolbyContent))}if(featureJson.Feature4D==1){featureAndServices.push(String.format('<i class="ico_c_f07" title="{0}">&nbsp;</i>',featureJson.Feature4DContent))}if(featureJson.Feature4DX==1){featureAndServices.push(String.format('<i class="ico_c_f29" title="{0}">&nbsp;</i>',featureJson.Feature4DXContent))}if(featureJson.Loveseat==1){featureAndServices.push(String.format('<i class="ico_c_f15" title="{0}">&nbsp;</i>',featureJson.LoveseatContent))}if(featureJson.HallCustomPropertyName==1){featureAndServices.push(String.format('<i class="ico_c_f28" title="{0}">&nbsp;</i>',featureJson.HallCustomPropertyContent))}if(featureJson.GlassFor3D==1){var depositDes="";switch(featureJson.GlassFor3DDeposit){case 1:depositDes="需押金";break;case 0:depositDes="免押金";break;case 2:depositDes="需购买";break}featureAndServices.push(String.format('<i class="ico_c_f09" title="{0}">&nbsp;</i>{1}',featureJson.GlassFor3DContent,depositDes))}if(featureJson.FeaturePark==1){featureAndServices.push(String.format('<i class="ico_c_f14" title="{0}">&nbsp;</i>可停车',featureJson.FeatureParkContent))}if(featureJson.SelfServiceTicket==1){featureAndServices.push(String.format('<i class="ico_c_f25" title="{0}">&nbsp;</i>取票机',featureJson.FeatureParkContent))}if(featureJson.CardPay==1){featureAndServices.push(String.format('<i class="ico_c_f12" title="{0}">&nbsp;</i>刷卡',featureJson.CardPayContent))}if(featureJson.Wifi==1){featureAndServices.push(String.format('<i class="ico_c_f13" title="{0}">&nbsp;</i>Wifi',featureJson.WIFIConent))}if(featureJson.DisabledSeat==1){featureAndServices.push(String.format('<i class="ico_c_f26" title="{0}">&nbsp;</i>无障碍',featureJson.DisabledSeatContent))}if(featureJson.IsServiceCustomProperty==1){featureAndServices.push(String.format('<i class="ico_c_f27" title="{0}">&nbsp;</i>{1}',featureJson.ServiceCustomPropertyContent,featureJson.ServiceCustomPropertyName))}}}var htmlBuilder=new StringBuilder();for(var i=0;i<Math.min(featureAndServices.length,7);i++){htmlBuilder.append(featureAndServices[i])}return htmlBuilder.toString()},CinemaPromotionTagRender:function(h){if(!h.promotions||h.promotions.length<=0){return}var k=new StringBuilder();k.append('<div class="coupbox">');for(var l=0;l<h.promotions.length;l++){var m=h.promotions[l];if(m.ActivityType==3){continue}var j="coup_other";if(m.ActivityType==1){j="coup_mtime"}var o="###";var n="";if(m.PCURL){o=m.PCURL;n=' target="_blank"'}if(m.SourceID==3){k.append(String.format('<div class="{0}" title="{1}"><a method="toggleAppPromTip" href="###">{2}<em>▼</em></a>',j,m.Description,m.TagName));k.append('<div class="coup_tip" style="display: none;">');k.append(String.format("<p>{0}</p>",m.Description));k.append(String.format('<p><img src="{0}" width="115" height="115"></p>',appQRcodeSrc));k.append("<p>扫一扫下载客户端</p>");k.append("</div></div> ")}else{k.append(String.format('<div class="{0}" title="{1}"><a href="{2}"{3}>{4}</a></div> ',j,m.Description,o,n,m.TagName))}}k.append("</div>");return k.toString()},onClickCinemaRegion:function(e){var d=Event.element(e);var f=d.readAttribute("method");while(!f&&d!=document.body){d=d.up();f=d.readAttribute("method")}if(!f){return}switch(f){case"addfavorite":this.addFavorite(d);break;case"delfavorite":this.delFavorite(d);break;case"toggleAppPromTip":this.toggleAppPromTip(d);break;default:break}},cinemaRegionMouseOver:function(g){var h=Event.findElement(g,"dt");if(h&&h!=document&&h.hasAttribute("data-selector")&&h.readAttribute("data-selector")=="favregion"){var e=h.down('a[method="addfavorite"]');var f=h.down('a[method="delfavorite"]');if(e&&!e.hasClassName("currstar")){e.style.cssText="display:inline-block;"}if(f&&e.hasClassName("currstar")){f.style.cssText="display:inline-block;"}}},cinemaRegionMouseOut:function(g){var h=Event.findElement(g,"dt");if(h&&h!=document&&h.hasAttribute("data-selector")){var e=h.down('a[method="addfavorite"]');var f=h.down('a[method="delfavorite"]');if(e&&!e.hasClassName("currstar")){e.style.cssText=""}if(f&&e.hasClassName("currstar")){f.style.cssText=""}}},addFavorite:function(f){if(typeof f!="undefined"){var d=f.next('a[method="delfavorite"]');if(typeof d=="undefined"||d.visible()){return}var e=Number(f.readAttribute("cid"));if(e>0){this.server.AddFavorite(e,function(a){if(a&&a.value){if(a.value.success){f.addClassName("currstar");d.show()}else{if(a.value.errcode=="nologin"){if(typeof UserLoginDialog!=="undefined"){new UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs("/js/2014/UserLoginDialog.js",function(){new UserLoginDialog({callback:function(){location.reload()}})}.bind(this))}}else{$alert("添加收藏失败，请稍后重试")}}}else{$alert("添加收藏失败，请稍后重试")}}.bind(this),f)}}},delFavorite:function(d){if(typeof d!="undefined"){var c=Number(d.readAttribute("cid"));if(c>0){this.server.DelFavorite(c,function(a){if(a&&a.value){if(a.value.success){d.hide();if(d.previous('a[method="addfavorite"]')){d.previous('a[method="addfavorite"]').removeClassName("currstar")}}else{if(a.value.errcode=="nologin"){if(typeof UserLoginDialog!=="undefined"){new UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs("/js/2014/UserLoginDialog.js",function(){new UserLoginDialog({callback:function(){location.reload()}})}.bind(this))}}else{$alert("取消收藏失败，请稍后重试")}}}else{$alert("取消收藏失败，请稍后重试")}}.bind(this),d)}}},toggleAppPromTip:function(f){if(typeof f!="undefined"){var e=f.next(".coup_tip");var d=f.down("em");if((typeof e)=="undefined"){return}if(d.innerHTML=="▼"){d.innerHTML="▲";e.show()}else{d.innerHTML="▼";e.hide()}}},onClickMoreCinemaBtn:function(){this.pageIndex++;this.CinemaListRender()},observControl:function(){if(typeof CinemaFilterControl!="undefined"){var b=new CinemaFilterControl({clickRegion:"areaAndSubwayFilter",container:"areaAndSubwayfilterBox",districtJson:districtJson,subwayJson:subwayJson,callBack:function(e,f){this.locationFilterType=e;this.locationFilterId=f;var a=this.getFilterCinemas();this.validCinemas=a!=null?a.clone():[];this.CinemaListRender()}.bind(this)})}if($("inputCinameKeyword")){this.theaterFilter=new TheaterFilter({theaters:typeof cinemasJson=="undefined"?[]:cinemasJson.list,district:0,searchInput:"inputCinameKeyword",searchBtn:"buttonCinameKeyword",searchTip:"cinemaSearchTip",historyDataCookieName:"theaterChannelSearchHistoryCookie",filterCallback:function(a){window.location.href=a[0].showtimepage}.bind(this)})}},onClickFilterRegion:function(f){var e=Event.element(f);var h=e.readAttribute("v");if(e!==document){if(h){if(e.tagName=="I"){if(!e.hasClassName("notcheck")){if(e.hasClassName("on")){e.removeClassName("on")}else{e.addClassName("on")}}}else{if(e.tagName=="LABEL"){if(!e.previous("i").hasClassName("notcheck")){if(e.previous("i").hasClassName("on")){e.previous("i").removeClassName("on")}else{e.previous("i").addClassName("on")}}}else{return}}this.getFeatureFilterValue();this.pageIndex=1;var g=this.getFilterCinemas();this.validCinemas=g!=null?g.clone():[];this.CinemaListRender()}}},getFeatureFilterValue:function(){if(this.featureFilterRegion){this.featureFilterValue.clear();$$("#featureFilter i[v]").each(function(b){if(b.hasClassName("on")){this.featureFilterValue.push(Number(b.readAttribute("v")))}}.bind(this))}},intilizFeatureFilterRender:function(){if(this.featureFilterRegion){if(typeof cinemasJson!="undefined"&&cinemasJson.totalcount>0){var isTicket=false;var isPark=false;var is3D=false;var isIMAX=false;var is4DX=false;for(var i=0;i<cinemasJson.totalcount;i++){var cinema=cinemasJson.list[i];var filterValue=[];if(cinema.isticket){isTicket=true;filterValue.push(1)}if(cinema.feature&&cinema.feature!=""){var feature=eval("("+cinema.feature+")");if(feature.FeaturePark=="1"){isPark=true;filterValue.push(2)}if(feature.Feature3D=="1"){is3D=true;filterValue.push(3)}if(feature.FeatureIMAX=="1"){isIMAX=true;filterValue.push(4)}if(feature.Feature4DX=="1"){is4DX=true;filterValue.push(5)}}cinemasJson.list[i].filtervalue=filterValue.join("")}$$("#featureFilter i[v]").each(function(item){var v=item.readAttribute("v");if(v=="1"){if(isTicket){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{if(v=="2"){if(isPark){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{if(v=="3"){if(is3D){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{if(v=="4"){if(isIMAX){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{if(v=="5"){if(is4DX){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{}}}}}item.removeClassName("on")}.bind(this))}}},getChineseSubString:function(o,n){var m=0,j=o.split(""),p=[];n=n*2;var l=j.length;for(var k=0;k<l;++k){if(j[k].charCodeAt(0)<299){m+=1;if(m<=n-2){p.push(j[k])}}else{m+=2;if(m<=n-2){p.push(j[k])}}}var q=p.join("");if(q!=""&&n<m){q=q+".."}return q},close:function(){this.destroyControl();this.destroyEvent();this.destroyDOM()}});var TicketSearchBox=Class.create();Object.extend(TicketSearchBox.prototype,{options:{container:"",cityId:null},CINEMA_NAME_SIZE:14,CINEMA_NAME_SIZE_BOX:7,oldMovieId:0,oldTheaterId:0,currentMeunIndex:0,onlineTicketShowtimeMenuNumber:3,server:{GetOnlineMoviesInCity:function(e,d,f){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetOnlineMoviesInCity",[e],d,"/Cinema.api","get","60000",f)},GetOnlineTheatersInCity:function(f,g,e,h){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetOnlineTheatersInCity",[f,g],e,"/Cinema.api","get","60000",h)},GetOnlineTheatersByMovieIdInCity:function(g,h,j,f,k){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetOnlineTheatersByMovieIdInCity",[g,h,j],f,"/Cinema.api","get","60000",k)},GetOnlineMoviesInTheater:function(f,g,e,h){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetOnlineMoviesInTheater",[f,g],e,"/Cinema.api","get","60000",h)},GetOnlineTicketShowtime:function(g,f,e,h){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetOnlineTicketShowtime",[g,f],e,"/Cinema.api","get","60000",h)},GetCinemaMoviePromotionPrice:function(f,h,g,e){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetCinemaMoviePromotionPrice",[f,h,g],e,"/Cinema.api","get","60000",null)}},initialize:function(b){this.setOptions(b);this.initializeDom();this.load()},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initializeDom:function(){this.container=$(this.container)},load:function(){if(this.cityId&&this.container){this.getOnlineMoviesInCity()}},builderHtml:function(){this.movieBoxTxt=Builder.node("span",{},["选电影"]);this.movieBox=Builder.node("div",{className:"moviemid m_movie __r_c_",pan:"M14_TheaterIndex_Search_Movie"},[this.movieBoxTxt,Builder.node("a",{href:"javaScript:;",className:"ico_select"},[])]);this.theaterBoxTxt=Builder.node("span",{},["选影院"]);this.theaterBox=Builder.node("div",{className:"moviemid m_film __r_c_",pan:"M14_TheaterIndex_Search_Cinema"},[this.theaterBoxTxt,Builder.node("a",{href:"javaScript:;",className:"ico_select"},[])]);this.timeBoxTxt=Builder.node("span",{},["选时间"]);this.timeBox=Builder.node("div",{className:"moviemid m_time nottime __r_c_",pan:"M14_TheaterIndex_Search_Showtime"},[this.timeBoxTxt,Builder.node("a",{href:"javaScript:;",className:"ico_select"},[])]);var d=this.hasOnlineTicket?"选座购票":"查影讯";var c=this.hasOnlineTicket?"":"none";this.ticketBtn=Builder.node("a",{href:"javaScript:;",className:"ticket false __r_c_",pan:"M14_TheaterIndex_Search_Button"},[d]);this.picTxt=Builder.node("b",{},[this.lowestPrice]);this.pic=Builder.node("strong",{className:"none"},[this.picTxt,"元起"]);this.ticketInfo=Builder.node("div",{className:"ticketinfo"},[this.ticketBtn,this.pic]);this.container.appendChild(this.movieBox);this.container.appendChild(this.theaterBox);this.container.appendChild(this.timeBox);this.container.appendChild(this.ticketInfo);this.initializeEvent()},initializeEvent:function(){this.onClickContainerHandler=this.onClickContainer.bind(this);Event.observe(this.container,"click",this.onClickContainerHandler);this.onOverContainerHandler=this.onOverContainer.bind(this);Event.observe(this.container,"mouseover",this.onOverContainerHandler);this.onClickBodyHandler=this.onClickBody.bind(this);Event.observe(document.body,"click",this.onClickBodyHandler);Event.observe(window,"unload",this.close.bind(this))},lowestPriceMethod:function(b){if(this.pic&&b>0){$show(this.pic);this.pic.innerHTML="<b>"+b+"</b>元起"}},onOverContainer:function(d){var c=Event.findElement(d,"a");if(c!==document){c.focus();c=null}},onClickContainer:function(l){var k=Event.findElement(l,"li");if(k!==document){this.onClickMovieBoxMethod(k);if(this.movieId&&this.theaterId){this.movieListElement=null;this.theaterListElement=null;this.getOnlineTicketShowtimeMethod()}else{this.server.GetOnlineTheatersByMovieIdInCity(this.cityId,this.movieId,this.hasOnlineTicket,function(a){if(a&&a.value){this.lowestPrice=a.value.lowestPrice;this.lowestPriceMethod(this.lowestPrice)}}.bind(this))}return}var g=Event.findElement(l,"a");if(g!==document&&!g.hasClassName("ico_select")){var m=g.readAttribute("typetarget");if(m==="theater"){this.onClickTheaterBoxMethod(g);if(this.movieId&&this.theaterId){this.movieListElement=null;this.theaterListElement=null;this.getOnlineTicketShowtimeMethod()}else{this.server.GetOnlineMoviesInTheater(this.theaterId,this.hasOnlineTicket,function(a){if(a&&a.value){this.lowestPrice=a.value.lowestPrice;this.lowestPriceMethod(this.lowestPrice)}}.bind(this))}}if(this.leftbtn&&g===this.leftbtn){if(!g.hasClassName("false")){this.onClickLeftbtn()}}if(this.rightbtn&&g===this.rightbtn){if(!g.hasClassName("false")){this.onClickRightbtn()}}if(g.hasClassName("clearinfo")){this.clearBoxMethod()}return}var j=Event.findElement(l,"div");if(j===this.movieBox){if(this.movieListElement&&!this.movieListElement.hasClassName("none")){$hide(this.movieListElement)}else{this.getOnlineMoviesInCity()}return}else{if(j===this.theaterBox){if(this.theaterListElement&&!this.theaterListElement.hasClassName("none")){$hide(this.theaterListElement)}else{this.getOnlineTheatersInCity()}return}else{if(this.movieId&&this.theaterId&&j===this.timeBox){if(this.onlineTicketShowtimeElement&&!this.onlineTicketShowtimeElement.hasClassName("none")){$hide(this.onlineTicketShowtimeElement);if(this.ticketInfo){$show(this.ticketInfo)}}else{this.getOnlineTicketShowtime()}return}}}var h=Event.findElement(l,"dd");if(h!==document){this.onClickTimeBoxMenuMethod(h);return}},clickCityCallBack:function(){if(this.ticketInfo){$show(this.ticketInfo)}if(this.movieListElement){$hide(this.movieListElement)}if(this.theaterListElement){$hide(this.theaterListElement)}if(this.onlineTicketShowtimeElement){$hide(this.onlineTicketShowtimeElement)}},clearBoxMethod:function(){this.theaterId=null;this.movieId=null;this.movies=null;this.districts=null;this.favCinemas=null;this.cinemasLen=null;this.theaterBoxTxt.innerHTML="选影院";this.movieBoxTxt.innerHTML="选电影";this.ticketBtn.href="javaScript:;";if(!this.ticketBtn.hasClassName("false")){this.ticketBtn.addClassName("false")}if(!this.timeBox.hasClassName("nottime")){this.timeBox.addClassName("nottime")}this.addId=null;$show(this.ticketInfo);if(this.movieListElement){$hide(this.movieListElement);this.movieListElement.remove();this.movieListElement=null;if(this.movieFilterTextCtrl){this.movieFilterTextCtrl.close();this.movieFilterTextCtrl=null}}if(this.theaterListElement){$hide(this.theaterListElement);this.theaterListElement.remove();this.theaterListElement=null;if(this.theaterFilterTextCtrl){this.theaterFilterTextCtrl.close();this.theaterFilterTextCtrl=null}}if(this.onlineTicketShowtimeElement){$hide(this.onlineTicketShowtimeElement);this.onlineTicketShowtimeElement.remove();this.onlineTicketShowtimeElement=null}this.pic.innerHTML="";this.lowestPrice=this.firstLowestPrice},onClickMovieBoxMethod:function(c){var d=c.readAttribute("movieid");if(d){this.movieId=d;this.movieTitel=this.strShort(c.down("span").innerHTML,this.CINEMA_NAME_SIZE_BOX);if(this.theaterId){if(this.theaterBoxTxt){this.theaterBoxTxt.innerHTML=this.theaterTitel+'<a href="" onclick="return false;" class="clearinfo">清除</a>'}this.movieBoxTxt.innerHTML=this.movieTitel+'<a href="" onclick="return false;" class="clearinfo">清除</a>'}else{this.movieBoxTxt.innerHTML=this.movieTitel}if(this.movieListElement){$hide(this.movieListElement);this.showElementMethod(this.movieLists)}if(this.ticketBtn.hasClassName("false")){this.ticketBtn.removeClassName("false")}if(this.movieId&&this.theaterId&&this.hasOnlineTicket){this.timeBox.removeClassName("nottime");this.ticketBtn.href=String.format(this.movieShowtimePageCinemaUrl,this.stringId,this.movieId,this.theaterId)}else{this.ticketBtn.href=String.format(this.movieShowtimeUrl,this.stringId,this.movieId);this.ticketBtn.target="_blank"}}},onClickTheaterBoxMethod:function(d){var f=d.readAttribute("value");var e=d.readAttribute("stringId");this.theaterTitel=this.strShort(d.innerHTML,this.CINEMA_NAME_SIZE_BOX);if(this.movieId){this.theaterBoxTxt.innerHTML=this.theaterTitel+'<a href="" onclick="return false;" class="clearinfo">清除</a>';if(this.movieBoxTxt){this.movieBoxTxt.innerHTML=this.movieTitel+'<a href="" onclick="return false;" class="clearinfo">清除</a>'}}else{this.theaterBoxTxt.innerHTML=this.theaterTitel}this.theaterId=f;if(this.theaterListElement){$hide(this.theaterListElement);this.movieLists&&this.showElementMethod(this.movieLists)}if(this.ticketBtn.hasClassName("false")){this.ticketBtn.removeClassName("false")}if(this.movieId&&this.theaterId&&this.hasOnlineTicket){this.timeBox.removeClassName("nottime");this.ticketBtn.href=String.format(this.movieShowtimePageCinemaUrl,this.stringId,this.movieId,this.theaterId)}else{this.ticketBtn.href=String.format(this.showTimeTheaterUrl,e,this.theaterId);this.ticketBtn.target="_blank"}},onClickTimeBoxMenuMethod:function(f){var g=f.readAttribute("menuindex");if(g){if(f.hasClassName("on")){return}g=parseInt(g);var e=this.builderOneDateOnlineTicketShowtimeHtml(this.dateShowtimes,g);this.onlineTicketShowtimeList.innerHTML=e;f.addClassName("on");if(this.dateMenuLists){this.dateMenuLists[this.currentMeunIndex].removeClassName("on")}this.currentMeunIndex=g;var h=this.dateShowtimes[g].date.replace(/-/g,"");this.LoadPromotionPrice(this.theaterId,h,this.movieId)}},builderMovieListHtml:function(){if(this.theaterListElement){$hide(this.theaterListElement);this.cinemasListElements&&this.showTheaterElementMethod(this.cinemasListElements)}if(this.onlineTicketShowtimeElement){$hide(this.onlineTicketShowtimeElement)}if(this.movies&&this.movies.length>0){if(this.movieListElement){this.movieListElement.remove();this.movieListElement=null}var l=this.movies.length,m,k=new StringBuilder();this.movieListElement=Builder.node("div",{className:"moviestip __r_c_",pan:"M14_TheaterIndex_Search_Movie"});for(i=0;i<l;i++){m=this.movies[i];m.title=this.strShort(m.title,this.CINEMA_NAME_SIZE);var j=new StringBuilder();var o="";if(this.movies[i].rating!==""){o='<b class="db_point">#{rating}</b>'}j.append('<li movieid="#{movieId}"><a href="javaScript:;">'+o+"<span>#{title}</span></a></li>");var p=new Template(j.toString());k.append(p.evaluate(this.movies[i]))}var q=new Date().getTime();this.movieSelectTextId="movieSelectText_"+q;this.movieListElement.innerHTML='<div class="searcher"><input id="'+this.movieSelectTextId+'" type="text" class="input c_a5" value="输入影片名称快速定位"><i class="sub"></i></div><ul>'+k.toString()+"</ul>";this.container.appendChild(this.movieListElement);var n=this.movieListElement.down("ul");this.movieLists=n.immediateDescendants();this.searchMovieMethod()}},searchMovieMethod:function(){var b=$(this.movieSelectTextId);if(b&&typeof Textbox!=="undefined"){this.movieFilterTextCtrl=new Textbox({text:b,value:"",watermarkText:"输入影片名称快速定位",focusClassName:"",blurClassName:"c_a5",onKeyupCallback:this.filterMovie.bind(this)})}},filterMovie:function(){var h=this.movieFilterTextCtrl.getValue();if(this.movieLists&&this.movieLists.length>0){var f=this.movieLists.length,g,e;if(h.length>0){for(e=0;e<f;e++){g=this.movieLists[e].down("span").innerHTML.toLowerCase();if(g.indexOf(h.toLowerCase())>-1){$show(this.movieLists[e])}else{$hide(this.movieLists[e])}}}else{this.showElementMethod(this.movieLists)}}},onClickBody:function(f){var e=Event.element(f);var h=e.up(".movieselectbox");var g=e.up(".moviemid");if(h!==this.container){if(this.movieListElement){$hide(this.movieListElement);this.showElementMethod(this.movieLists)}if(this.theaterListElement){$hide(this.theaterListElement)}if(this.onlineTicketShowtimeElement){$hide(this.onlineTicketShowtimeElement)}$show(this.ticketInfo)}else{var g=e.up(".moviemid");if(g===this.movieBox){if(this.theaterListElement){$hide(this.theaterListElement)}if(this.onlineTicketShowtimeElement){$hide(this.onlineTicketShowtimeElement)}$show(this.ticketInfo)}if(g===this.theaterBox){if(this.movieListElement){$hide(this.movieListElement);this.showElementMethod(this.movieLists)}if(this.onlineTicketShowtimeElement){$hide(this.onlineTicketShowtimeElement)}$show(this.ticketInfo)}if(g===this.timeBox){if(this.movieListElement){$hide(this.movieListElement);this.showElementMethod(this.movieLists)}if(this.theaterListElement){$hide(this.theaterListElement)}}}},showElementMethod:function(f){var e=f.length;for(var d=0;d<e;d++){$show(f[d])}},getOnlineMoviesInCity:function(){if(this.theaterId){if(this.movieListElement){$show(this.movieListElement)}else{this.oldTheaterId=this.theaterId;if(this.movieListElement){this.movieListElement.remove();this.movieListElement=null}this.server.GetOnlineMoviesInTheater(this.theaterId,this.hasOnlineTicket,function(b){if(b&&b.value){this.lowestPrice=b.value.lowestPrice;this.movies=b.value.movies;this.builderMovieListHtml()}}.bind(this))}}else{if(this.firstMovies){this.movies=this.firstMovies;this.builderMovieListHtml();return}this.server.GetOnlineMoviesInCity(this.cityId,function(b){if(b&&b.value){this.hasOnlineTicket=b.value.hasOnlineTicket;this.firstLowestPrice=b.value.lowestPrice;this.lowestPrice=b.value.lowestPrice;this.firstMovies=b.value.movies;this.movies=b.value.movies;this.stringId=b.value.stringId;this.movieShowtimeUrl=b.value.movieShowtimeUrl;this.showTimeTheaterUrl=b.value.showTimeTheaterUrl;this.movieShowtimePageCinemaUrl=b.value.movieShowtimePageCinemaUrl;this.cinemaCount=b.value.cinemaCount;this.builderHtml()}}.bind(this))}},getOnlineTheatersInCity:function(){if(this.movieId){if(this.theaterListElement){$show(this.theaterListElement)}else{this.oldMovieId=this.movieId;if(this.theaterListElement){this.theaterListElement.remove();this.theaterListElement=null}this.server.GetOnlineTheatersByMovieIdInCity(this.cityId,this.movieId,this.hasOnlineTicket,function(b){if(b&&b.value){this.lowestPrice=b.value.lowestPrice;this.districts=b.value.districts;this.districts.push({districtId:0,name:"其它",cinemas:[]});this.favCinemas=b.value.favCinemas;this.cinemasLen=b.value.cinemas.length;this.getTheaterData(b.value.cinemas);this.builderTheaterListHtml()}}.bind(this))}}else{this.server.GetOnlineTheatersInCity(this.cityId,this.hasOnlineTicket,function(b){if(b&&b.value){this.districts=b.value.districts;this.districts.push({districtId:0,name:"其它",cinemas:[]});this.favCinemas=b.value.favCinemas;this.cinemasLen=b.value.cinemas.length;this.getTheaterData(b.value.cinemas);this.builderTheaterListHtml()}}.bind(this))}},getOnlineTicketShowtime:function(){var b=this.movieId+"_"+this.theaterId;if(this.addId&&this.addId===b){this.builderOnlineTicketShowtimeHtml();$hide(this.ticketInfo);return}this.server.GetOnlineTicketShowtime(this.movieId,this.theaterId,function(a){if(a&&a.value){this.lowestPrice=a.value.lowestPrice;this.addId=this.movieId+"_"+this.theaterId;this.dates=this.getDateConversion(a.value.dates);this.dateShowtimes=a.value.dateShowtimes;this.ticketUrl=a.value.ticketUrl;this.builderOnlineTicketShowtimeHtml();this.loadPromotionPrice_Enable=a.value.loadPromotionPrice_Enable;$hide(this.ticketInfo)}}.bind(this))},getOnlineTicketShowtimeMethod:function(){this.server.GetOnlineTicketShowtime(this.movieId,this.theaterId,function(b){if(b&&b.value){this.lowestPrice=b.value.lowestPrice;this.addId=this.movieId+"_"+this.theaterId;this.dates=this.getDateConversion(b.value.dates);this.dateShowtimes=b.value.dateShowtimes;this.ticketUrl=b.value.ticketUrl;this.loadPromotionPrice_Enable=b.value.loadPromotionPrice_Enable;this.lowestPriceMethod(this.lowestPrice)}}.bind(this))},builderTheaterListHtml:function(){if(this.movieListElement){$hide(this.movieListElement);this.movieLists&&this.showElementMethod(this.movieLists)}if(this.onlineTicketShowtimeElement){$hide(this.onlineTicketShowtimeElement)}if(this.theaterListElement){$show(this.theaterListElement)}else{if(this.districts&&this.districts.length>0){if(this.theaterListElement){this.theaterListElement.remove();this.theaterListElement=null}var j=Builder.node("p",{className:"clearfix pb9"});var k=new Date().getTime();this.theaterSelectTextId="theaterSelectText_"+k;j.innerHTML='<span class="searcher"><input id="'+this.theaterSelectTextId+'" type="text" class="input c_a5" value="输入影院名称快速定位"><i class="sub"></i></span><span class="lh25">当前共有'+this.cinemasLen+"家影院</span>";var f,g=this.districts.length;this.cinemasList=Builder.node("div",{className:"arealist"});if(this.favCinemas.length>0){this.favCinemasList=this.getCinemasListP(this.favCinemas,"常去影院");this.favCinemasList.style.borderBottom="1px solid #bababa";this.favCinemasList.style.paddingBottom="10px";this.cinemasList.appendChild(this.favCinemasList)}for(var h=0;h<g;h++){f=this.getCinemasListP(this.districts[h].cinemas,this.districts[h].name);this.cinemasList.appendChild(f)}this.theaterListElement=Builder.node("div",{className:"cinematip __r_c_",style:"left: 400px",pan:"M14_TheaterIndex_Search_Cinema"},[j,this.cinemasList]);this.container.appendChild(this.theaterListElement);this.cinemasLists=this.cinemasList.immediateDescendants();this.cinemasListElements=this.getCinemasArray(this.cinemasLists);this.searchTheaterMethod()}}},searchTheaterMethod:function(){var b=$(this.theaterSelectTextId);if(b&&typeof Textbox!=="undefined"){this.theaterFilterTextCtrl=new Textbox({text:b,value:"",watermarkText:"输入影院名称快速定位",focusClassName:"",blurClassName:"c_a5",onKeyupCallback:this.filterTheater.bind(this)})}},filterTheater:function(){var n=this.theaterFilterTextCtrl.getValue();if(this.cinemasListElements&&this.cinemasListElements.length>0){var l=this.cinemasListElements.length,o,m,h;if(n.length>0){if(this.favCinemasList){$hide(this.favCinemasList)}for(var j=0;j<l;j++){h=this.cinemasListElements[j];m=h.length;$hide(this.cinemasLists[j]);for(var k=1;k<m;k++){o=h[k].innerHTML.toLowerCase();if(o.indexOf(n.toLowerCase())>-1){$show(this.cinemasLists[j]);$show(h[k])}else{$hide(h[k])}}}}else{if(this.favCinemasList){$show(this.favCinemasList)}this.showTheaterElementMethod(this.cinemasListElements)}}},showTheaterElementMethod:function(g){var l=g.length,j,m,h;for(j=0;j<l;j++){h=g[j];m=h.length;$show(this.cinemasLists[j]);for(var k=1;k<m;k++){$show(h[k])}}},getTheaterData:function(f){if(this.districts&&this.districts.length>0&&f&&f.length>0){var h=this.districts.length;var g=f.length;for(var j=0;j<h;j++){this.districts[j].cinemas=[];for(var k=0;k<g;k++){if(this.districts[j].districtId===f[k].districtId){this.districts[j].cinemas.push(f[k])}}}}},getCinemasArray:function(f){var e=[];if(f&&f.length>0){var g=f.length;for(var h=0;h<g;h++){e[h]=f[h].immediateDescendants()}}return e},getCinemasListP:function(f,h){var e;var g=document.createElement("p");g.className="oftenlist alist";if(f&&f.length>0){e=this.getCinemasListA(f);g.innerHTML=String.format("<span>{0}</span>{1}",h,e)}return g},getCinemasListA:function(h){var m=new Template('<a href="#" value="#{cinemaId}" stringId="#{stringId}" typetarget="theater" onclick="return false;">#{name}</a>');var l=new StringBuilder();var g;for(var j=0,k=h.length;j<k;j++){g=h[j];if(g.name.bytelength()>40){g.name=g.name.substr(0,19)+".."}l.append(m.evaluate(g));this.cinemaCount++}return l.toString()},builderOnlineTicketShowtimeHtml:function(){if(this.movieListElement){$hide(this.movieListElement);this.movieLists&&this.showElementMethod(this.movieLists)}if(this.theaterListElement){$hide(this.theaterListElement);this.cinemasListElements&&this.showTheaterElementMethod(this.cinemasListElements)}if(this.dates&&this.dates.length>0){this.datesLen=this.dates.length;var m=this.datesLen>3?"":"false";this.leftbtn=Builder.build('<a class="lastday false" style="left:0;" href="javaScript:;" ><i></i></a>');this.rightbtn=Builder.build('<a class="nextday '+m+'" style="right:0;" href="javaScript:;"><i></i></a>');var q=new StringBuilder(),o,r;var l=200*this.datesLen;for(r=0;r<this.datesLen;r++){var k="";if(r===0){k="on"}q.append('<dd class="'+k+'" menuindex="'+r+'">'+this.dates[r]+"</dd>")}this.dateMenuList=Builder.node("dl",{className:"transition4",style:"width:"+l+"px; left:0px;"});this.dateMenuList.innerHTML=q.toString();this.dateMenuLists=this.dateMenuList.immediateDescendants();var p=Builder.node("div",{className:"i_datetab"},[this.leftbtn,this.rightbtn,Builder.node("div",{className:"i_dates"},[this.dateMenuList])]);var n=this.builderOneDateOnlineTicketShowtimeHtml(this.dateShowtimes,0);this.onlineTicketShowtimeList=Builder.node("ul",{});this.onlineTicketShowtimeList.innerHTML=n;if(this.onlineTicketShowtimeElement){this.container.removeChild(this.onlineTicketShowtimeElement)}this.onlineTicketShowtimeElement=Builder.node("div",{className:"i_date __r_c_",pan:"M14_TheaterIndex_Search_Showtime"},[p,Builder.node("div",{className:"showdate"},[this.onlineTicketShowtimeList])]);this.container.appendChild(this.onlineTicketShowtimeElement);this.meunIndex=this.onlineTicketShowtimeMenuNumber;this.meunItemWidth=this.dateMenuLists[0].getWidth();var s=this.dateShowtimes[0].date.replace(/-/g,"");this.LoadPromotionPrice(this.theaterId,s,this.movieId)}},builderOneDateOnlineTicketShowtimeHtml:function(q,u){if(q&&q.length>0){var r=q[u].showtimes.length,p,v,o,y,A,w,s,z;var t=new StringBuilder();for(i=0;i<r;i++){p=q[u].showtimes[i];A=p.version?p.version+",":"";w=p.language?p.language+",":"";s=p.hallName?p.hallName:"";v=A+w+s;y=p.salePrice;o=p.cinemaPrice;z=String.format(this.ticketUrl,p.showtimeId);var x=p.isNext?"<i>（次日）</i>":"";t.append('<li id="price_'+p.showtimeId+'" newprice="'+y+'" oldprice="'+o+'"> <a href="'+z+'" target="_blank" ><span class="time">'+p.timeReal+x+'</span> <span class="ting">'+v+'</span> <span class="mprice" style="display:none">￥'+y+'</span> <span class="yprice" style="display:none">'+(o>0?("￥"+o):"")+' </span><span class="tbtn">选座购票</span></a> </li>')}return t.toString()}return""},LoadPromotionPrice:function(d,f,e){if(this.loadPromotionPrice_Enable){this.server.GetCinemaMoviePromotionPrice(d,f,e,function(v){if(v&&v.value&&v.value.success&&v.value.priceList){for(var c=0;c<v.value.priceList.length;c++){var t=v.value.priceList[c];var w=t.ShowtimeID;if(!w||w<=0){continue}var a=$("price_"+w);if(!a){continue}var p=a.getAttribute("newprice");var r=a.getAttribute("oldprice");var u=Number(t.PromotionPrice)/100;var b=false;if(u<p){b=true;r=p;p=u}if(b){var q=q=String.format("¥{0}<em></em>",p);var s=String.format("¥{0}",r);a.down(".mprice").innerHTML=q;a.down(".yprice").innerHTML=s}}}$$(".mprice").invoke("show");$$(".yprice").invoke("show")})}else{$$(".mprice").invoke("show");$$(".yprice").invoke("show")}},onClickLeftbtn:function(){this.meunIndex--;if(this.meunIndex<=this.onlineTicketShowtimeMenuNumber){this.meunIndex=this.onlineTicketShowtimeMenuNumber;this.leftbtn.addClassName("false")}if(this.rightbtn.hasClassName("false")){this.rightbtn.removeClassName("false")}var b=this.meunItemWidth*(this.onlineTicketShowtimeMenuNumber-this.meunIndex);this.dateMenuList.style.left=b+"px"},onClickRightbtn:function(){this.meunIndex++;if(this.meunIndex>=this.datesLen){this.meunIndex=this.datesLen;this.rightbtn.addClassName("false")}if(this.leftbtn.hasClassName("false")){this.leftbtn.removeClassName("false")}var b=this.meunItemWidth*(this.onlineTicketShowtimeMenuNumber-this.meunIndex);this.dateMenuList.style.left=b+"px"},getDateConversion:function(h){var f=[],k=h.length,g;for(var j=0;j<k;j++){g=new Date(getFomartDateStr(h[j]));f.push(getDateString(g))}return f},strShort:function(n,m){var l=0,h=n.split(""),o=[];m=(m||8)*2;var k=h.length;for(var j=0;j<k;++j){if(h[j].charCodeAt(0)<299){l++}else{l+=2}o.push(h[j]);if(l>=m-2){o.push("..");break}}return o.join("")},close:function(){this.destroyEvent();this.destroyDOM();this.destroyField()},destroyField:function(){},destroyEvent:function(){Event.stopObserving(document.body,"click",this.onClickBodyHandler);Event.stopObserving(this.container,"click",this.onClickContainerHandler)},destroyDOM:function(){this.movieBox=null;this.theaterBox=null;this.timeBox=null;this.ticketInfo=null;this.container=null}});Date.prototype.Format=function(d){var f={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(d)){d=d.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var e in f){if(new RegExp("("+e+")").test(d)){d=d.replace(RegExp.$1,(RegExp.$1.length==1)?(f[e]):(("00"+f[e]).substr((""+f[e]).length)))}}return d};function getWeek(c){var d;if(c.getDay()==0){d="周日"}if(c.getDay()==1){d="周一"}if(c.getDay()==2){d="周二"}if(c.getDay()==3){d="周三"}if(c.getDay()==4){d="周四"}if(c.getDay()==5){d="周五"}if(c.getDay()==6){d="周六"}return d}function getFomartDateStr(strDate){return strDate.replace(eval("/-/gi"),"/")}function getDateString(k){var o=new Date();var m="";var h=o.getDate();var j=k.getDate();var l=j-h;var n=k.Format("M月d日");if(l===0){m="今天 ("+n+")"}else{if(l===1){m="明天 ("+n+")"}else{if(l===2){m="后天 ("+n+")"}else{m=getWeek(k)+"("+n+")"}}}return m}var CityMenuControl=Class.create();Object.extend(CityMenuControl.prototype,{server:{getData:function(b){if(typeof threaterListBoxData!=="undefined"&&threaterListBoxData.locations){b&&b()}else{$loadJs("/Utility/Data/TheaterListBoxData.m",b)}},getTheaterCityHomeURL:function(c,d){if(typeof theaterService==="undefined"){return Mtime.Component.Ajax.callBack("Mtime.Showtime.Pages.ShowtimeService","GetTheaterCityHomeURL",[c],d,"/service/showtime.ms","get","25000")}else{return Mtime.Component.Ajax.request(theaterService,"Mtime.Showtime.Pages.ShowtimeService","GetTheaterCityHomeURL",[c],d,"/service/showtime.ms","get","25000")}}},options:{items:[],hotSearchItems:[290,292,293,365,974,366,561,880,791],HOTROWSIZE:10,order:"热门",container:"",isTip:true,triggerElement:"",optionTS:"<li><a value=#{Id}>#{NameCn}</a></li>",boxLimitHeight:false,clickCallBack:null,callBack:null,content:{regRxpAG:["A","B","C","D","E","F","G"],regRxpHL:["H","I","J","K","L"],regRxpMT:["M","N","O","P","Q","R","S","T"],regRxpWZ:["U","V","W","X","Y","Z"]}},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.optionTemplate=new Template(this.optionTS);this.initializeDOM();this.initializeEvent();this.getItems()},initializeDOM:function(){var p="";this.firstBool=false;this.isTip1=this.isTip;if(this.isTip){this.headPanel=$(this.triggerElement);var m=this.getXY(this.headPanel);var k=m.y;var j=0;if(m.x>=560){j=m.x-560}else{j=m.x}var q=Windows.getZIndex()+1;p="display: none; width: 560px; position: absolute; top: "+k+"px; left: "+j+"px;z-index:"+q;this._parentNode=Builder.node("div",{className:"showfilm userbar",style:p});m=k=j=q=null}else{this.container=$(this.container);this._parentNode=Builder.node("div",{className:"showfilm userbar",style:"display: none;"})}this.closeNode=Builder.node("span",{className:"btn_close fr"},["关闭"]);this.contentBox=Builder.node("div");this.searchCityText=Builder.node("input",{type:"text",className:"text"});this.tab=Builder.node("span",{className:"cityletter"},[Builder.node("a",{href:"#",onclick:"return false;",className:"on",_v:"热门"},["热门",Builder.node("b",[" "])]),Builder.node("a",{href:"#",onclick:"return false;",_v:"A-G"},["A-G",Builder.node("b",[" "])]),Builder.node("a",{href:"#",onclick:"return false;",_v:"H-L"},["H-L",Builder.node("b",[" "])]),Builder.node("a",{href:"#",onclick:"return false;",_v:"M-T"},["M-T",Builder.node("b",[" "])]),Builder.node("a",{href:"#",onclick:"return false;",_v:"W-Z"},["W-Z",Builder.node("b",[" "])])]);this.span=Builder.node("span",{className:"fl w30 bold mt5"});this.bodyPanel=$(Builder.node("div",{id:"showtime_tip",className:"showtime_tip"},[Builder.node("div",{className:"share_tit clearfix"},[this.closeNode,Builder.node("div",{className:"citysearch"},[this.searchCityText]),this.tab]),Builder.node("div",{className:"p15"},[this.contentBox])]));if(this.headPanel){this._parentNode.appendChild(this.bodyPanel);document.body.appendChild(this._parentNode)}else{if(this.container){this._parentNode.appendChild(this.bodyPanel);var o=this.container.up();o.appendChild(this._parentNode)}}var l=this.tab.childNodes;for(var n=0;n<l.length;n++){Event.observe(l[n],"click",function(c){var a=c.target||c.srcElement;if(a.innerHTML!==this.order){$A(this.tab.childNodes).each(function(d){d.className=""});a.className="on";var b=a.readAttribute("_v");this.order=b;this.reload(b)}}.bind(this))}if(!this.isTip&&this.container){this.headPanel=this.container}},initializeEvent:function(){this.ononSearchCityTextFocusHandler=this.onSearchCityTextFocus.bind(this);this.onSearchCityTextBlurHandler=this.onSearchCityTextBlur.bind(this);this.onCloseHandler=this.hide.bind(this);Event.observe(this.searchCityText,"focus",this.ononSearchCityTextFocusHandler);Event.observe(this.searchCityText,"blur",this.onSearchCityTextBlurHandler);if(this.headPanel){this.onHeadPanelClickHandler=this.onHeadPanelClick.bind(this);Event.observe(this.headPanel,"click",this.onHeadPanelClickHandler)}Event.observe(this.closeNode,"click",this.onCloseHandler);this.onClickPageHandler=this.onClickPage.bindAsEventListener(this);Event.observe(document.body,"click",this.onClickPageHandler)},destroyEvent:function(){this.ononSearchCityTextFocusHandler&&Event.stopObserving(this.searchCityText,"focus",this.ononSearchCityTextFocusHandler);this.onSearchCityTextBlurHandler&&Event.stopObserving(this.searchCityText,"blur",this.onSearchCityTextBlurHandler);this.onCloseHandler&&Event.stopObserving(this.closeNode,"click",this.onCloseHandler)},destroyPanel:function(){this.closeNode=null;this.contentBox=null;this.searchCityText=null;this.tab=null;this.span=null;this.bodyPanel=null;this.headPanel=null;this._parentNode=null},close:function(){this.destroyEvent();this.destroyPanel()},onClickPage:function(e){var d=Event.element(e);var f=d.up(".showtime_tip");if(this.isTip&&f!==this.bodyPanel){if(this.isShowing()){this.hide()}}},getHotItems:function(){if(!this.hotItems){this.hotItems=this.items.sortBy(function(b){return -b.OTicketCinemaCount}).slice(0,40).sortBy(function(b){return -b.VisitedTimes}).collect(function(b){return b.Id})}return this.hotItems},reload:function(k){this.contentBox.update();var f=null;switch(k){case"热门":if(!this.content.HOT){this.content.HOT=this.createOptions(this.getCitys(this.items,this.getHotItems())," ",true)}this.contentBox.update(this.content.HOT);if(this.boxLimitHeight){this.contentBox.style.overflowY="";this.contentBox.style.height=""}break;case"A-G":if(!this.content.AG){f=this.items.findAll(function(a){var b=/[A-G]/.test(a.initial);return b});this.content.AG=this.makeNodes(f,this.content.regRxpAG)}this.contentBox.update(this.content.AG);if(this.boxLimitHeight){this.contentBox.style.overflowY="auto";this.contentBox.style.height="410px"}break;case"H-L":if(!this.content.HL){f=this.items.findAll(function(a){var b=/[H-L]/.test(a.initial);return b});this.content.HL=this.makeNodes(f,this.content.regRxpHL)}this.contentBox.update(this.content.HL);if(this.boxLimitHeight){this.contentBox.style.overflowY="auto";this.contentBox.style.height="410px"}break;case"M-T":if(!this.content.MT){f=this.items.findAll(function(a){var b=/[M-T]/.test(a.initial);return b});this.content.MT=this.makeNodes(f,this.content.regRxpMT)}this.contentBox.update(this.content.MT);if(this.boxLimitHeight){this.contentBox.style.overflowY="auto";this.contentBox.style.height="410px"}break;case"W-Z":if(!this.content.WZ){f=this.items.findAll(function(a){var b=/[M-Z]/.test(a.initial);return b});this.content.WZ=this.makeNodes(f,this.content.regRxpWZ)}this.contentBox.update(this.content.WZ);if(this.boxLimitHeight){this.contentBox.style.overflowY="auto";this.contentBox.style.height="410px"}break;default:break}var j=this.contentBox.getElementsByTagName("li");for(var h=0,g=j.length;h<g;h++){Event.observe(j[h],"click",function(b){var a=b.target||b.srcElement;this.command(a.getAttribute("value"))}.bind(this))}},makeNodes:function(h,k){var o=new StringBuilder();for(var l=0,j=k.length;l<j;l++){var n=k[l];var m=h.findAll(function(a){return a.initial===n}).sortBy(function(a){return -a.VisitedTimes});if(m.length>0){o.append(this.createOptions(m,n))}}return o.toString()},getItems:function(){this.locations=[];this.server.getData(function(){if(typeof threaterListBoxData!=="undefined"&&threaterListBoxData.locations){this.locations=threaterListBoxData.locations.List}this.items=[];this.locations.each(function(c){var d={Id:c.Id,NameCn:c.NameCn,NameEn:c.NameEn,initial:c.NameEn.charAt(0).toLocaleUpperCase(),PinyinShort:c.PinyinShort||"",VisitedTimes:c.VisitedTimes,OTicketCinemaCount:c.OTicketCinemaCount};this.items.push(d)}.bind(this));this.reload("热门");this.cityAutoComplete=new CityAutoCompleteControl({text:this.searchCityText,textWatermarkText:"直接输入城市或城市拼音",listRegion:this.contentBox,itemTemplate:'<li value="#{Id}"><span class="fl">#{NameEn}</span><span class="fr">#{NameCn}</span></li>',idFieldName:"Id",titleFieldName:"NameCn",searchDatas:this.items,defaultSearchDatas:this.getCitys(this.items,this.hotSearchItems),choiceCount:9,doCommand:this.command.bind(this),onEnterCallback:function(f){var h=this.contentBox.getElementsByTagName("li");for(var g=0,e=h.length;g<e;g++){if(h[g].className==="on"){this.command(h[g].getAttribute("value"));break}}}.bind(this)})}.bind(this))},createOptions:function(k,h,j){var l=Builder.node("div");var m=new StringBuilder();m.append('<div class="city_list2 clearfix">');m.append('<span class="fl w30 bold mt5">'+h+"</span>");m.append("<ul>");for(var g=0;g<k.length;g++){if(j&&g!==0&&(g%this.HOTROWSIZE===0)){m.append('</ul><span class="fl w30 bold mt5"> </span><ul>')}m.append(this.optionTemplate.evaluate(k[g]))}m.append("</ul>");m.append("</div>");return m.toString()},onSearchCityTextFocus:function(){$A(this.tab.childNodes).each(function(b){b.className=""})},onSearchCityTextBlur:function(b){this.order=null},onHeadPanelClick:function(f){f&&Event.stop(f);if(this.isShowing()){this.hide()}else{if(this.isTip1&&!this.firstBool&&this.headPanel&&this._parentNode){this.firstBool=true;var e=this.getXY(this.headPanel);var d=e.y;this._parentNode.style.top=d+"px"}this.show()}this.clickCallBack&&this.clickCallBack()},isShowing:function(){return(this._parentNode.style.display!="none")},show:function(){this._parentNode.show()},hide:function(){this._parentNode.hide()},command:function(b){if(b!==null){this.callBack&&this.callBack(b)}},getCitys:function(o,l){var m=[];for(var n=0;n<l.length;n++){var k=l[n];var j=this.getCity(o,k);if(j!==null){m.push(j)}}if(m.length<l.length){var q=l.length-m.length;for(var p=0;p<o.length;p++){if(q===0){break}if(!l.include(o[p].Id)){m.push(o[p]);q--}}}return m},getCity:function(h,e){for(var f=0,g=h.length;f<g;f++){if(e==h[f].Id){return h[f]}}return null},getXY:function(h){var j=0,k=0;if(h){if(h.getBoundingClientRect){var a=h.getBoundingClientRect();var b=document.documentElement;j=Math.round(a.left+Math.max(b.scrollLeft,document.body.scrollLeft)-b.clientLeft);k=Math.round(a.top+Math.max(b.scrollTop,document.body.scrollTop)-b.clientTop)}else{for(;h!=document.body;j+=h.offsetLeft,k+=h.offsetTop,h=h.offsetParent){}}}return{x:j,y:k}}});var CityAutoCompleteControl=Class.create();Object.extend(Object.extend(CityAutoCompleteControl.prototype,AutoCompleteBase.prototype),{initialize:function(b){this.baseInitialize(b)},initializeField:function(){this.firstRender=true;this.isShowMoreResult=false;this.isAutoMatchSuggest=true},initializeDOM:function(){},destroyDOM:function(){this.listTipText=null},initializeEvent:function(){},destroyEvent:function(){},baseInitializeEvent:function(){},getEntry:function(e){this.active=false;var f=this.listRegion.getElementsByTagName("li");var d=f.length;if(d>e&&e>=0){return $(f[e])}return null},onEnterText:function(){if(this.onEnterCallback){this.onEnterCallback()}},onObserverEvent:function(){var b=this.getSearchKeyword();if(b.length>=this.minChars){if(b!=this.keyword){this.keyword=b;this.render()}}else{this.keyword="";this.active=false;this.render()}},onBlurText:function(d,c){this.active=false;this.hasFocus=false;this.removeObserver()},reset:function(){this.selectedValue=null;this.index=0;this.searchIndex=0;this.entryCount=0},onClick:function(){},onClickText:function(){},onFocusText:function(b){this.hasFocus=true;this.active=true;this.render()},match:function(c,d){if((d.PinyinShort.toLowerCase().indexOf(c.toLowerCase())===0)){return true}else{if((d.NameCn.toLowerCase().indexOf(c.toLowerCase())===0)||(d.NameEn.toLowerCase().indexOf(c.toLowerCase())===0)){return true}}return false},onKeydownText:function(b){if(this.handled){this.handled=false;return}this.handled=true;switch(b.keyCode){case Event.KEY_RETURN:this.onEnterText();Event.stop(b);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();Event.stop(b);return;case Event.KEY_DOWN:this.markNext();Event.stop(b);return;default:this.addObserver();this.onChangeInput();break}},doRender:function(){if(this.isEnable){if(this.changed){this.reset()}var c=this.getSearchKeyword();if(c.length===0){this.removeObserver();this.renderDefaultList();if(Prototype.Browser.Gecko&&this.hasFocus){setTimeout(function(){var a=this.getSearchKeyword();if(a!=this.keyword){var b=this.getMoreLists();if(this.isAlwayShowList||this.entryCount>0){this.renderTip(a,this.entryCount);this.renderList(this.changed,b)}}}.bind(this),1000)}}else{var d=this.getMoreLists();if(this.isAlwayShowList||this.entryCount>0){this.renderTip(c,this.entryCount);this.renderList(this.changed,d);this.showSelectList()}else{this.hideSelectList()}}}},renderTip:function(c,d){if(this.firstRender||c===""){this.firstRender=false;this.listTipText="输入中文/拼音或按&uarr;&darr;选择"}else{if(d>0){this.listTipText=c+"，按拼音数排序"}else{this.listTipText="对不起，找不到："+c}}},renderList:function(l,o){var j='<div class="sou_window"><div class="sou_note">'+this.listTipText+'</div><div class="sou_city"><ul>'+o+"</ul></div></div>";this.listRegion.update(j);var n=this.listRegion.getElementsByTagName("li");for(var k=0,h=n.length;k<h;k++){var m=n[k];m.style.cursor="pointer";Event.observe(m,"click",function(b){var a=b.target||b.srcElement;if(a.nodeName=="SPAN"){a=a.parentNode}this.doCommand(a.getAttribute("value"))}.bind(this));Event.observe(m,"mouseover",function(b){var c=this;if(Prototype.Browser.IE){var a=b.target||b.srcElement;if(a.nodeName=="SPAN"){c=a.parentNode}else{c=a}}$A(c.parentNode.childNodes).each(function(d){d.className=""});c.className="on"});Event.observe(m,"mouseout",function(b){var c=this;if(Prototype.Browser.IE){var a=b.target||b.srcElement;if(a.nodeName=="SPAN"){c=a.parentNode}else{c=a}}c.className=""})}if(n.length>0){n[0].className="on"}}});var FixedElement=Class.create();Object.extend(FixedElement.prototype,{options:{element:null},initialize:function(b){this.setOptions(b);this.initializeDom();this.initializeEvent();this.load()},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initializeDom:function(){this.el=$(this.element);if(!this.el){return}this.coordinate=this.getXY(this.el)},initializeEvent:function(){this.checkerHandler=this.checker.bind(this);if(this.el){Event.observe(window,"scroll",this.checkerHandler);Event.observe(window,"unload",this.close.bind(this))}},load:function(){},checker:function(){var b=document.documentElement.scrollTop||document.body.scrollTop;if(b>this.coordinate.y){this.el.setStyle({position:"fixed",top:"0px",width:"100%"})}else{this.el.setStyle({position:"relative",top:"",width:""})}},getXY:function(h){var j=0,k=0;if(h.getBoundingClientRect){var a=h.getBoundingClientRect();var b=document.documentElement;j=Math.round(a.left+Math.max(b.scrollLeft,document.body.scrollLeft)-b.clientLeft);k=Math.round(a.top+Math.max(b.scrollTop,document.body.scrollTop)-b.clientTop)}else{for(;h!=document.body;j+=h.offsetLeft,k+=h.offsetTop,h=h.offsetParent){}}return{x:j,y:k}},close:function(){this.destroyEvent();this.destroyDOM();this.destroyField()},destroyField:function(){},destroyEvent:function(){if(this.el){Event.stopObserving(window,"scroll",this.checkerHandler)}},destroyDOM:function(){this.el=null}});var CinemaChannelPage=Class.create();Object.extend(CinemaChannelPage.prototype,{hotplayJson:[],searchMovieUrl:"",menuOn:null,server:{loadData:function(h,j,k,m,g,l){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","CinemaChannelIndexLoadData",[h,j,k,m],g,"/Cinema.api","get","60000",l)},getCinemaChannelPageUrlByCityId:function(e,d,f){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetCinemaChannelPageUrlByCityId",[e],d,"/Cinema.api","get","60000",f)}},options:{cityId:290},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeServerData();this.initializeDOM();this.initializeEvent();this.initializeControl();this.load()},initializeServerData:function(){this.hotplayJson=typeof hotplaySvList=="undefined"?[]:hotplaySvList},initializeDOM:function(){this.hotplayMoreLink=$("hotplayMoreLink");this.hotplayMoreDiv=$("hotplayMoreDiv");this.hotplayMenu=$("hotplayMenu");this.hotplayContent=$("hotplayContent");if(this.hotplayMenu&&this.hotplayContent){this.menus=this.hotplayMenu.immediateDescendants();this.contents=this.hotplayContent.immediateDescendants()}this.upcomingRegion=$("upcomingRegion");this.ticketSearchFixDiv=$("ticketSearchFixDiv")},destroyDOM:function(){this.hotplayMoreLink=null;this.hotplayMoreDiv=null;this.hotplayMenu=null;this.hotplayContent=null;if(typeof this.menus!="undefined"){this.menus.clear();this.menus=null}if(typeof this.contents!="undefined"){this.contents.clear();this.contents=null}this.upcomingRegion=null;this.ticketSearchFixDiv=null},initializeEvent:function(){if(this.hotplayMoreLink){this.onClickHotplayMoreLinkHandler=this.showMoreHotplayMovies.bind(this);Event.observe(this.hotplayMoreLink,"click",this.onClickHotplayMoreLinkHandler)}if(this.hotplayMenu){this.onClickHotplayMenuHandler=this.onClickHotplayMenu.bindAsEventListener(this);this.hotplayMenu.observe("click",this.onClickHotplayMenuHandler)}Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){if(this.hotplayMoreLink){Event.stopObserving(this.hotplayMoreLink,"click",this.onClickHotplayMoreLinkHandler)}if(this.hotplayMenu){this.hotplayMenu.stopObserving("click",this.onClickHotplayMenuHandler)}},initializeControl:function(){if($("headImgDotSlidesRegion")){this.headImgSlide=new Widgets.IndexTopSlidesControl({slidesRegion:"headImgSlidesRegion",dotSlidesRegion:"headImgDotSlidesRegion",backSlidesRegion:"headImgBackSlidesRegion",txtSlidesRegion:"headImgTxtSlidesRegion",prev:"headImgPre",next:"headImgNext",autoTimeout:5})}if($("ticketSearchDiv")){this.ticketSearchBox=new TicketSearchBox({container:"ticketSearchDiv",cityId:this.cityId})}if(this.ticketSearchFixDiv){}if($("upcomingNext")){this.upcomingSlideCtrl=new Widgets.DistanceSlidesControl({slidesRegion:"upcomingSlide",prev:"upcomingPre",next:"upcomingNext",slidesRegionWidth:622,itemWidth:311})}if($("changeCityDiv")){this.cityMenuCtrl=new CityMenuControl({container:"changeCityDiv",isTip:false,boxLimitHeight:true,clickCallBack:this.clickCityCallBack.bind(this),callBack:this.changeCityMethod.bind(this)});var b=this.cityMenuCtrl.getXY(this.cityMenuCtrl.headPanel);this.cityMenuCtrl.isTip=true;this.cityMenuCtrl._parentNode.setStyle({width:"560px",position:"absolute",top:"60px",left:"0px",zIndex:101})}},clickCityCallBack:function(){if(this.ticketSearchBox){this.ticketSearchBox.clickCityCallBack()}},initialHotplaySearchCtrl:function(){if($("hotplaySearchText")){this.hotplayMovieSearch=new HotplayMovieSearch({textInput:"hotplaySearchText",resultRegion:"hotplaySearchResultDl",searchHotplayLink:"hotplaySearchButton",hotplayJson:this.hotplayJson,searchMovieUrl:this.searchMovieUrl})}},destroyControl:function(){if(this.headImgSlide){this.headImgSlide.close();this.headImgSlide=null}if(this.ticketSearchBox){this.ticketSearchBox.close();this.ticketSearchBox=null}if(this.fixCtrl){this.fixCtrl.close();this.fixCtrl=null}if(this.hotplayMovieSearch){this.hotplayMovieSearch.close();this.hotplayMovieSearch=null}if(this.upcomingSlideCtrl){this.upcomingSlideCtrl.close();this.upcomingSlideCtrl=null}if(this.cityMenuCtrl){this.cityMenuCtrl.close();this.cityMenuCtrl=null}},load:function(){this.loadData();this.observControl();if(this.menus!==null&&this.menus.length>0){this.setMenuOn(this.menus[0])}this.hashLocation()},loadData:function(){var j=$$('#headImgTxtSlidesRegion span[method="hotplay"]');var f=this.getMovieIdArray(j);j=$$('#headImgTxtSlidesRegion span[method="upcoming"]');var g=this.getMovieIdArray(j);var h=this.getHotplayMovieIds();j=$$('#upcomingSlide p[method="presell"]');var k=this.getMovieIdArray(j);this.server.loadData(f.join(","),g.join(","),h.join(","),k.join(","),this.loadDataCallback.bind(this))},getMovieIdArray:function(m){var h=[];if(m.length>0){var k;var l=0;for(var g=0,j=m.length;g<j;g++){k=m[g].getAttribute("mid");if(k){l=parseInt(k,10);if(l>0){h.push(l)}}}}return h},getHotplayMovieIds:function(){var g=[];if(this.hotplayJson.length>0){var e;for(var f=0,h=this.hotplayJson.length;f<h;f++){e=this.hotplayJson[f];g.push(e.Id)}}return g},loadDataCallback:function(o){if(o&&o.value){var j=o.value.headImgHotplayShowtime;if(j&&j.length>0){var n=$$('#headImgTxtSlidesRegion span[method="hotplay"]');this.setNodeContent(j,n)}var l=o.value.headImgUpcomingWant;if(l&&l.length>0){n=$$('#headImgTxtSlidesRegion span[method="want"]');this.setNodeContent(l,n)}var k=o.value.headImgUpcomingCinema;if(k&&k.length>0){n=$$('#headImgTxtSlidesRegion span[method="upcoming"]');this.setNodeContent(k,n)}var m=o.value.hotplayRatingList;if(m&&m.length>0){n=$$('#hotplayContent div[class="score none"]');this.setMovieRating(m,n,true);n=$$('#hotplayContent span[class="score none"]');this.setMovieRating(m,n,false);this.addRatingToHotplayJson(m)}var q=o.value.upcomingWant;if(q&&q.length>0){n=$$('#upcomingSlide span[method="want"]');this.setUpcomingWantCount(q,n)}var p=o.value.upcomingTicketList;if(p&&p.length>0){n=$$('#upcomingSlide p[method="presell"]');this.setUpcomingTicket(n,p)}this.searchMovieUrl=o.value.searchMovieUrl;this.initialHotplaySearchCtrl()}},setNodeContent:function(k,j){if(j.length>0){var h;for(var f=0,g=j.length;f<g;f++){h=j[f];h.innerHTML=k[f]}}},setUpcomingWantCount:function(m,l){if(l.length>0){var k,g;for(var h=0,j=l.length;h<j;h++){k=l[h];g=k.readAttribute("genre");if(g&&g==="1"&&m[h].length>0){k.innerHTML=m[h]+" - "}else{k.innerHTML=m[h]}}}},setMovieRating:function(j,p,l){if(p.length>0){var o;var n;var q;for(var k=0,m=p.length;k<m;k++){o=p[k];n=o.getAttribute("mid");if(n){n=parseInt(n,10);if(n>0){q=this.getRatingByMovieId(n,j);if(q.length>0){$show(o);if(l){o.innerHTML=String.format("<b>总评分</b><p>{0}</p>",q)}else{o.innerHTML=q}}}}}}},getRatingByMovieId:function(h,e){for(var f=0,g=e.length;f<g;f++){if(e[f].Id===h){return e[f].Rating}}return""},addRatingToHotplayJson:function(g){if(this.hotplayJson.length>0){var k;var f;for(var h=0,j=this.hotplayJson.length;h<j;h++){f=this.hotplayJson[h];k=this.getRatingByMovieId(f.Id,g);this.hotplayJson[h].Rating=k}}},setUpcomingTicket:function(n,o){if(n.length>0){var m;var k;var l;for(var h=0,j=n.length;h<j;h++){m=n[h];k=m.getAttribute("mid");if(k){k=parseInt(k,10);if(k>0){l=this.getTicketByMovieId(k,o);if(l.length>0){m.innerHTML=String.format('<a href="{0}" target="_blank">超前预售</a>',l)}}}}}},getTicketByMovieId:function(g,h){for(var e=0,f=h.length;e<f;e++){if(h[e].Id===g){return h[e].MovieShowTimePageDate}}return""},observControl:function(){var b=new CinemaListControl();if(typeof(RightFloatToolsControl)!="undefined"){this.shareCtrl=new RightFloatToolsControl({hasShareButton:false,hasFavoriteButton:false,hasMessageButton:false,hasCodeButton:false})}},showMoreHotplayMovies:function(){if(this.hotplayMoreLink.hasClassName("curr")){this.hotplayMoreLink.removeClassName("curr");this.hotplayMoreLink.innerHTML="<i></i>更多";$hide(this.hotplayMoreDiv);document.getElementById("backHere").scrollIntoView(false)}else{this.hotplayMoreLink.addClassName("curr");this.hotplayMoreLink.innerHTML="<i></i>收回";$show(this.hotplayMoreDiv)}},changeCityMethod:function(b){if(b>0){setCookie("DefaultCity-CookieKey",b);this.server.getCinemaChannelPageUrlByCityId(b,this.getCinemaChannelPageUrlByCityIdCallback.bind(this))}},getCinemaChannelPageUrlByCityIdCallback:function(b){if(b&&b.value&&b.value.url){$redirect(b.value.url)}},setMenuOn:function(d){var c=this.indexOf(d);if(c>=0){if(this.onMenuActiveCallback){this.onMenuActiveCallback(d,c)}}},onMenuActiveCallback:function(d,c){if(this.menuOn!=d){this.on(d,c)}},onClickHotplayMenu:function(g){var f=Event.findElement(g,"a");if(f!==null){var h=this.indexOf(f);if(h>=0){var e=Event.element(g);if(this.onClickMenuCallback){this.onClickMenuCallback(f,h)}}}},onClickMenuCallback:function(d,c){if(this.menuOn!=d){this.on(d,c)}},on:function(d,c){this.beforeOn(d,c);d.addClassName("on");this.showMenuContent(c)},beforeOn:function(d,c){if(this.menuOn&&this.menuOn!==null){this.off(this.menuOn,this.menuOn.index)}this.menuOn=d;this.menuOn.index=c},off:function(d,c){if(d.className!==""){d.removeClassName("on");this.hideMenuContent(c)}},indexOf:function(j){if(j&&j!==null){var k=this.menus,h=null;for(var g=0,f=k.length;g<f;g++){h=k[g];if(h==j){return g}}}return -1},showMenuContent:function(c){var d=this.contents[c];if(!$visible(d)){$show(d)}},hideMenuContent:function(c){var d=this.contents[c];if($visible(d)){$hide(d)}},hashLocation:function(){var b=location.hash;if(b.length===0){return}if(b==="#hotplay"&&this.ticketSearchFixDiv){this.ticketSearchFixDiv.scrollIntoView();this.showMoreHotplayMovies()}else{if(b==="#cinema"&&this.upcomingRegion){this.upcomingRegion.scrollIntoView()}}},close:function(){this.destroyControl();this.destroyEvent();this.destroyDOM();this.hotplayJson=null;this.searchMovieUrl=null;this.cityId=null}});var HotplayMovieSearch=Class.create();Object.extend(HotplayMovieSearch.prototype,{TITLE_SIZE:10,options:{textInput:"",resultRegion:"",searchHotplayLink:"",hotplayJson:[],searchMovieUrl:""},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField();this.initializeDOM();this.initializeEvent();this.initializeControl()},initializeField:function(){this.cache={}},initializeDOM:function(){this.textInput=$(this.textInput);this.resultRegion=$(this.resultRegion);this.searchHotplayLink=$(this.searchHotplayLink)},initializeEvent:function(){this.searchHotplayLinkHandler=this.searchHotplayLinkClick.bind(this);Event.observe(this.searchHotplayLink,"click",this.searchHotplayLinkHandler)},destroyDOM:function(){this.textInput=null;this.resultRegion=null;this.searchHotplayLink=null},destroyEvent:function(){Event.stopObserving(this.searchHotplayLink,"click",this.searchHotplayLinkHandler)},initializeControl:function(){this.autoMovieSearch=new SearchAutoComplete({text:this.textInput,textWatermarkText:"搜索影片",listRegion:this.resultRegion,itemTemplate:'<dd><a href="#{Url}">#{RatingHTML}#{Title}</a></dd>',idFieldName:"Title",titleFieldName:"Title",searchDatas:null,getSearchDataCallback:function(b){this.timeout&&clearTimeout(this.timeout);this.timeout=setTimeout(this.searchMovie.bind(this,b),500)}.bind(this),choiceCount:8,isAlwayShowList:true,onChangeInputCallback:null,onChangeCallback:null,onClickListRegion:function(d){var c=Event.findElement(d,"dd");if(c!=document){this.removeObserver();this.selectedEntry(c);if(this.onEnterCallback){this.onEnterCallback(this.getValue())}}},onEnterCallback:this.submitInner.bind(this)})},getKeyWord:function(){return this.textInput.value},searchMovie:function(g){var l=this.getKeyWord();if(this.getKeyWord().trim().length){if(this.cache[l]){g&&g(this.cache[l])}else{var m=[];if(this.hotplayJson.length>0){var k;for(var h=0,j=this.hotplayJson.length;h<j;h++){k=this.hotplayJson[h];if(k.Title.toLowerCase().indexOf(l.toLowerCase())>=0){k.RatingHTML=k.Rating&&k.Rating.length>0?String.format('<span class="score fr">{0}</span>',k.Rating):"";if(k.Title.bytelength()>this.TITLE_SIZE*2){k.Title=k.Title.substr(0,this.TITLE_SIZE-1)+".."}m.push(k)}}}this.cache[l]=m;g&&g(m)}}},searchHotplayLinkClick:function(){this.autoMovieSearch.onEnterCallback()},submitInner:function(b){if(b&&b.Url){location.href=b.Url}else{this.doSearch()}},doSearch:function(){if(this.getKeyWord().trim().length){var b=encodeURIComponent(this.getKeyWord().trim()).replace(/'/g,"%27");location.href=String.format(this.searchMovieUrl,b)}},close:function(){this.destroyDOM();this.destroyEvent()}});